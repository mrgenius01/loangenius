{% extends "dashboard/base.html" %}

{% block content %}
<!-- Enhanced Dashboard Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-1">üè¶ Comprehensive Loan Management Dashboard</h1>
        <p class="text-muted">Complete overview of users, loans, transactions and analytics</p>
    </div>
    <div class="btn-group" role="group">
        <button class="btn btn-primary" onclick="refreshAllData()">
            <i class="fas fa-sync-alt me-2"></i>Refresh All
        </button>
        <button class="btn btn-success" onclick="exportData()">
            <i class="fas fa-download me-2"></i>Export
        </button>
        <button class="btn btn-info" onclick="showSystemHealth()">
            <i class="fas fa-heart me-2"></i>System Health
        </button>
    </div>
</div>

<!-- Navigation Tabs -->
<ul class="nav nav-tabs mb-4" id="dashboardTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
            <i class="fas fa-chart-pie me-2"></i>Overview
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab">
            <i class="fas fa-users me-2"></i>Users <span class="badge bg-primary ms-1" id="user-count-badge">0</span>
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="loans-tab" data-bs-toggle="tab" data-bs-target="#loans" type="button" role="tab">
            <i class="fas fa-hand-holding-usd me-2"></i>Loans <span class="badge bg-success ms-1" id="loan-count-badge">0</span>
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="transactions-tab" data-bs-toggle="tab" data-bs-target="#transactions" type="button" role="tab">
            <i class="fas fa-money-bill-wave me-2"></i>Transactions <span class="badge bg-info ms-1" id="transaction-count-badge">0</span>
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="analytics-tab" data-bs-toggle="tab" data-bs-target="#analytics" type="button" role="tab">
            <i class="fas fa-chart-line me-2"></i>Analytics
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="security-tab" data-bs-toggle="tab" data-bs-target="#security" type="button" role="tab">
            <i class="fas fa-shield-alt me-2"></i>Security
        </button>
    </li>
</ul>

<!-- Tab Content -->
<div class="tab-content" id="dashboardTabsContent">
    
    <!-- Overview Tab -->
    <div class="tab-pane fade show active" id="overview" role="tabpanel">
        <!-- Summary Cards -->
        <div class="row mb-4" id="overview-cards">
            <div class="col-12 text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading overview...</span>
                </div>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-bolt me-2"></i>Quick Actions
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-2 mb-2">
                                <button class="btn btn-primary w-100" onclick="showAddUser()">
                                    <i class="fas fa-user-plus me-2"></i>Add User
                                </button>
                            </div>
                            <div class="col-md-2 mb-2">
                                <button class="btn btn-success w-100" onclick="showAddLoan()">
                                    <i class="fas fa-plus me-2"></i>Create Loan
                                </button>
                            </div>
                            <div class="col-md-2 mb-2">
                                <button class="btn btn-info w-100" onclick="showSystemHealth()">
                                    <i class="fas fa-heart-pulse me-2"></i>System Status
                                </button>
                            </div>
                            <div class="col-md-2 mb-2">
                                <button class="btn btn-warning w-100" onclick="showReports()">
                                    <i class="fas fa-file-export me-2"></i>Generate Report
                                </button>
                            </div>
                            <!-- <div class="col-md-2 mb-2">
                                <button class="btn btn-outline-secondary w-100" onclick="testCSRF()">
                                    <i class="fas fa-shield-alt me-2"></i>Test CSRF
                                </button>
                            </div> -->
                            <!-- <div class="col-md-2 mb-2">
                                <button class="btn btn-outline-info w-100" onclick="debugCSRF()">
                                    <i class="fas fa-bug me-2"></i>Debug CSRF
                                </button>
                            </div> -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Recent Activity -->
        <div class="row">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-clock me-2"></i>Recent Activity
                        </h5>
                    </div>
                    <div class="card-body" id="recent-activity">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-exclamation-triangle me-2"></i>Alerts & Notifications
                        </h5>
                    </div>
                    <div class="card-body" id="alerts-panel">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Users Tab -->
    <div class="tab-pane fade" id="users" role="tabpanel">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4>üë• User Management</h4>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="showAddUser()">
                    <i class="fas fa-user-plus me-2"></i>Add User
                </button>
                <button class="btn btn-outline-secondary" onclick="exportUsers()">
                    <i class="fas fa-download me-2"></i>Export
                </button>
            </div>
        </div>
        
        <!-- User Filters -->
        <div class="card mb-3">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <select class="form-select" id="user-role-filter" onchange="filterUsers()">
                            <option value="">All Roles</option>
                            <option value="admin">Admin</option>
                            <option value="customer">Customer</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="user-status-filter" onchange="filterUsers()">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <input type="text" class="form-control" id="user-search" placeholder="Search users..." onkeyup="searchUsers()">
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-outline-secondary w-100" onclick="clearUserFilters()">
                            <i class="fas fa-times me-2"></i>Clear
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Users Table -->
        <div class="card">
            <div class="card-body">
                <div class="table-responsive" id="users-table-container">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Loans Tab -->
    <div class="tab-pane fade" id="loans" role="tabpanel">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4>üè¶ Loan Management</h4>
            <div class="btn-group">
                <button class="btn btn-success" onclick="showAddLoan()">
                    <i class="fas fa-plus me-2"></i>Create Loan
                </button>
                <button class="btn btn-outline-secondary" onclick="exportLoans()">
                    <i class="fas fa-download me-2"></i>Export
                </button>
            </div>
        </div>
        
        <!-- Loan Summary Cards -->
        <div class="row mb-3" id="loan-summary-cards">
            <div class="col-12 text-center">
                <div class="spinner-border text-primary" role="status"></div>
            </div>
        </div>
        
        <!-- Loan Filters -->
        <div class="card mb-3">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <select class="form-select" id="loan-status-filter" onchange="filterLoans()">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="completed">Completed</option>
                            <option value="defaulted">Defaulted</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="loan-amount-filter" onchange="filterLoans()">
                            <option value="">All Amounts</option>
                            <option value="0-500">$0 - $500</option>
                            <option value="500-1000">$500 - $1,000</option>
                            <option value="1000-5000">$1,000 - $5,000</option>
                            <option value="5000+">$5,000+</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <input type="text" class="form-control" id="loan-search" placeholder="Search loans..." onkeyup="searchLoans()">
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-outline-secondary w-100" onclick="clearLoanFilters()">
                            <i class="fas fa-times me-2"></i>Clear
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Loans Table -->
        <div class="card">
            <div class="card-body">
                <div class="table-responsive" id="loans-table-container">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Transactions Tab -->
    <div class="tab-pane fade" id="transactions" role="tabpanel">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4>üí∞ Transaction Management</h4>
            <div class="btn-group">
                <button class="btn btn-info" onclick="refreshTransactions()">
                    <i class="fas fa-sync me-2"></i>Refresh
                </button>
                <button class="btn btn-outline-secondary" onclick="exportTransactions()">
                    <i class="fas fa-download me-2"></i>Export
                </button>
            </div>
        </div>
        
        <!-- Transaction Summary -->
        <div class="row mb-3" id="transaction-summary-cards">
            <div class="col-12 text-center">
                <div class="spinner-border text-primary" role="status"></div>
            </div>
        </div>
        
        <!-- Transaction Filters -->
        <div class="card mb-3">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-2">
                        <select class="form-select" id="transaction-status-filter" onchange="filterTransactions()">
                            <option value="">All Status</option>
                            <option value="completed">Completed</option>
                            <option value="pending">Pending</option>
                            <option value="failed">Failed</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" id="transaction-method-filter" onchange="filterTransactions()">
                            <option value="">All Methods</option>
                            <option value="ecocash">EcoCash</option>
                            <option value="onemoney">OneMoney</option>
                            <option value="telecash">TeleCash</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" id="transaction-period-filter" onchange="filterTransactions()">
                            <option value="">All Time</option>
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <input type="text" class="form-control" id="transaction-search" placeholder="Search transactions..." onkeyup="searchTransactions()">
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-outline-secondary w-100" onclick="clearTransactionFilters()">
                            <i class="fas fa-times me-2"></i>Clear
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Transactions Table -->
        <div class="card">
            <div class="card-body">
                <div class="table-responsive" id="transactions-table-container">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Analytics Tab -->
    <div class="tab-pane fade" id="analytics" role="tabpanel">
        <h4 class="mb-4">üìä Advanced Analytics</h4>
        
        <!-- Analytics Cards -->
        <div class="row mb-4" id="analytics-cards">
            <div class="col-12 text-center">
                <div class="spinner-border text-primary" role="status"></div>
            </div>
        </div>
        
        <!-- Charts Row -->
        <div class="row mb-4">
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">üìà Loan Performance Trends</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="loanTrendsChart" height="300"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">ü•ß Payment Method Distribution</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="paymentMethodChart" height="300"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">üìä Collection Rate by Month</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="collectionRateChart" height="300"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">üë• Customer Growth</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="customerGrowthChart" height="300"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Security Tab -->
    <div class="tab-pane fade" id="security" role="tabpanel">
        <h4 class="mb-4">üîí Security & Monitoring</h4>
        
        <!-- Security Overview -->
        <div class="row mb-4" id="security-cards">
            <div class="col-12 text-center">
                <div class="spinner-border text-primary" role="status"></div>
            </div>
        </div>
        
        <!-- Login Attempts -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">üö® Recent Login Attempts</h5>
            </div>
            <div class="card-body" id="login-attempts-table">
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status"></div>
                </div>
            </div>
        </div>
        
        <!-- System Health -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">üíö System Health Status</h5>
            </div>
            <div class="card-body" id="system-health">
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">üë§ Add New User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addUserForm">
                    <div class="mb-3">
                        <label class="form-label">Username</label>
                        <input type="text" class="form-control" name="username" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" name="email" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Full Name</label>
                        <input type="text" class="form-control" name="full_name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Phone Number</label>
                        <input type="tel" class="form-control" name="phone_number">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Role</label>
                        <select class="form-select" name="role" required>
                            <option value="customer">Customer</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-control" name="password" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitAddUser()">Create User</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Loan Modal -->
<div class="modal fade" id="addLoanModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">üè¶ Create New Loan</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addLoanForm">
                    <div class="mb-3">
                        <label class="form-label">Customer</label>
                        <select class="form-select" name="user_id" required>
                            <option value="">Select Customer...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Loan Amount ($)</label>
                        <input type="number" class="form-control" name="original_amount" step="0.01" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Interest Rate (%)</label>
                        <input type="number" class="form-control" name="interest_rate" step="0.01" value="15" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Term (Months)</label>
                        <input type="number" class="form-control" name="term_months" value="12" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Disbursement Date</label>
                        <input type="date" class="form-control" name="disbursement_date" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="submitAddLoan()">Create Loan</button>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Dashboard JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Global variables
let currentData = {};
let charts = {};

// CSRF Token for secure requests - inherit from base template or get from Jinja2
let CSRF_TOKEN = '';
if (typeof window.CSRF_TOKEN !== 'undefined') {
    CSRF_TOKEN = window.CSRF_TOKEN;
} else {
    CSRF_TOKEN = '{{ csrf_token }}';
}

// Expose to window for debugging
window.csrf_token = CSRF_TOKEN;
console.log('CSRF Token:', CSRF_TOKEN);

// Helper function to get CSRF headers
function getCSRFHeaders() {
    return {
        'Content-Type': 'application/json',
        'X-CSRF-Token': CSRF_TOKEN
    };
}

// Utility Functions - MUST BE DEFINED FIRST
function formatNumber(num) {
    if (num === null || num === undefined) return '0.00';
    return new Intl.NumberFormat('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }).format(num);
}

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    return new Date(dateString).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
    });
}

function getStatusColor(status) {
    const colors = {
        'active': 'success',
        'completed': 'primary',
        'defaulted': 'danger',
        'pending': 'warning',
        'failed': 'danger',
        'sent': 'info'
    };
    return colors[status] || 'secondary';
}

function showError(message) {
    console.error(message);
    // Create toast notification
    const toast = document.createElement('div');
    toast.className = 'position-fixed top-0 end-0 p-3';
    toast.style.zIndex = '9999';
    toast.innerHTML = `
        <div class="toast align-items-center text-white bg-danger border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;
    document.body.appendChild(toast);
    const toastEl = new bootstrap.Toast(toast.querySelector('.toast'));
    toastEl.show();
    setTimeout(() => toast.remove(), 5000);
}

function showSuccess(message) {
    console.log(message);
    // Create toast notification
    const toast = document.createElement('div');
    toast.className = 'position-fixed top-0 end-0 p-3';
    toast.style.zIndex = '9999';
    toast.innerHTML = `
        <div class="toast align-items-center text-white bg-success border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;
    document.body.appendChild(toast);
    const toastEl = new bootstrap.Toast(toast.querySelector('.toast'));
    toastEl.show();
    setTimeout(() => toast.remove(), 3000);
}

// Generic modal for viewing details
function showModal(title, bodyHtml) {
    let modal = document.getElementById('genericModal');
    if (!modal) {
        document.body.insertAdjacentHTML('beforeend', `
            <div class="modal fade" id="genericModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title"></h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body"></div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        `);
        modal = document.getElementById('genericModal');
    }
    modal.querySelector('.modal-title').innerHTML = title;
    modal.querySelector('.modal-body').innerHTML = bodyHtml;
    new bootstrap.Modal(modal).show();
}

// Guard transaction summary rendering
function renderTransactionSummaryCards(summary) {
    const container = document.getElementById('transaction-summary-cards');
    if (!summary) {
        container.innerHTML = '<p class="text-center">No transaction summary available.</p>';
        return;
    }
    container.innerHTML = `
        <div class="col-md-4">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <h4>${summary.total_transactions || 0}</h4>
                    <p class="mb-0">Total Transactions</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <h4>$${formatNumber(summary.total_amount || 0)}</h4>
                    <p class="mb-0">Total Amount</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <h4>${summary.successful_transactions || 0}</h4>
                    <p class="mb-0">Successful Transactions</p>
                </div>
            </div>
        </div>
    `;
}

function renderTransactionsTable(transactions) {
    const container = document.getElementById('transactions-table-container');
    if (!transactions || transactions.length === 0) {
        container.innerHTML = '<p class="text-center">No transactions found.</p>';
        return;
    }
    const tableHTML = `
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>Transaction ID</th>
                    <th>Loan ID</th>
                    <th>Amount</th>
                    <th>Fee</th>
                    <th>Total</th>
                    <th>Method</th>
                    <th>Status</th>
                    <th>Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                ${transactions.map(transaction => `
                    <tr>
                        <td><strong>${transaction.transaction_id}</strong></td>
                        <td><a href="#" onclick="viewLoanDetails(${transaction.loan_id})">${transaction.loan_id}</a></td>
                        <td>$${formatNumber(transaction.amount)}</td>
                        <td>$${formatNumber(transaction.fee)}</td>
                        <td>$${formatNumber(transaction.total)}</td>
                        <td><span class="badge bg-secondary">${transaction.method}</span></td>
                        <td><span class="badge bg-${getStatusColor(transaction.status)}">${transaction.status}</span></td>
                        <td>${formatDate(transaction.created_at)}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="viewTransactionDetails(${transaction.id})" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
    container.innerHTML = tableHTML;
}

function renderLoansTable(loans) {
    const container = document.getElementById('loans-table-container');
     if (!loans || loans.length === 0) {
        container.innerHTML = '<p class="text-center">No loans found.</p>';
        return;
    }
    const tableHTML = `
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>Loan ID</th>
                    <th>Customer</th>
                    <th>Amount</th>
                    <th>Outstanding</th>
                    <th>Status</th>
                    <th>Disbursed</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                ${loans.map(loan => `
                    <tr>
                        <td><strong>${loan.loan_id}</strong></td>
                        <td><a href="#" onclick="viewUserDetails(${loan.user_id})">${loan.customer_name}</a></td>
                        <td>$${formatNumber(loan.original_amount)}</td>
                        <td>$${formatNumber(loan.outstanding_balance)}</td>
                        <td><span class="badge bg-${getStatusColor(loan.status)}">${loan.status}</span></td>
                        <td>${formatDate(loan.disbursement_date)}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="editLoan(${loan.id})" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-info" onclick="viewLoanDetails(${loan.id})" title="View">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-outline-success" onclick="showPaymentForm(${loan.id})" title="Make Payment">
                                    <i class="fas fa-dollar-sign"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
    container.innerHTML = tableHTML;
}

// Load Transactions Data
async function loadTransactionsData() {
    try {
        const response = await fetch('/admin/api/transactions');
        const result = await response.json();
        if (result.status === 'success') {
            const payload = result.data;
            currentData.transactions = payload;
            renderTransactionSummaryCards(payload.summary);
            renderTransactionsTable(payload.transactions);
        } else {
            showError(result.message || 'Failed to load transactions');
        }
    } catch (error) {
        console.error('Error loading transactions data:', error);
        showError('Failed to load transactions data');
    }
}

// Analytics & Security Tab Loaders
async function loadAnalyticsData() {
    const container = document.getElementById('analytics-cards');
    container.innerHTML = '<div class="spinner-border text-primary" role="status"></div>';
    // Mock data for now
    setTimeout(() => {
        container.innerHTML = '<p class="text-center text-muted">Analytics feature coming soon.</p>';
        // In a real scenario, you would fetch data and initialize charts here
    }, 1000);
}

async function loadSecurityData() {
    const container = document.getElementById('security-cards');
    container.innerHTML = '<div class="spinner-border text-primary" role="status"></div>';
    // Mock data for now
    setTimeout(() => {
        container.innerHTML = '<p class="text-center text-muted">Security monitoring feature coming soon.</p>';
    }, 1000);
}


// Load Overview Data - CRITICAL FUNCTION
async function loadOverviewData() {
    try {
        const response = await fetch('/admin/api/overview');
        const result = await response.json();
        if (result.status === 'success') {
            const payload = result.data;
            currentData.overview = payload;
            renderOverviewCards(payload);
            if (payload.recent_activity) renderRecentActivity(payload.recent_activity);
            if (payload.alerts) renderAlerts(payload.alerts);
            updateBadges(payload);
        } else {
            console.error('Overview load failed:', result.message);
            showError(result.message || 'Failed to load overview');
        }
    } catch (error) {
        console.error('Error loading overview data:', error);
        showError('Failed to load overview data');
        // Show fallback content
        document.getElementById('overview-cards').innerHTML = '<p class="text-center text-muted">Failed to load overview data</p>';
    }
}

function renderOverviewCards(data) {
    const container = document.getElementById('overview-cards');
    container.innerHTML = `
        <div class="col-md-3 mb-3">
            <div class="card text-white bg-primary">
                <div class="card-body text-center">
                    <i class="fas fa-chart-pie fa-2x mb-2"></i>
                    <h4>${data.total_transactions || 0}</h4>
                    <p class="mb-0">Transactions</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card text-white bg-success">
                <div class="card-body text-center">
                    <i class="fas fa-dollar-sign fa-2x mb-2"></i>
                    <h4>$${formatNumber(data.total_amount || 0)}</h4>
                    <p class="mb-0">Total Amount</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card text-white bg-info">
                <div class="card-body text-center">
                    <i class="fas fa-users fa-2x mb-2"></i>
                    <h4>${data.total_users || 0}</h4>
                    <p class="mb-0">Users</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card text-white bg-warning">
                <div class="card-body text-center">
                    <i class="fas fa-hand-holding-usd fa-2x mb-2"></i>
                    <h4>${data.total_loans || 0}</h4>
                    <p class="mb-0">Loans</p>
                </div>
            </div>
        </div>
    `;
}

function renderRecentActivity(activity) {
    const container = document.getElementById('recent-activity');
    if (!activity || !Array.isArray(activity.loans)) {
        container.innerHTML = '<p class="text-center">No recent activity to display.</p>';
    } else {
        let html = '<ul class="list-group">';
        activity.loans.slice(0, 5).forEach(item => {
            html += `<li class="list-group-item d-flex justify-content-between">
                <span>Loan ${item.loan_id} created</span>
                <small class="text-muted">${formatDate(item.created_at)}</small>
            </li>`;
        });
        html += '</ul>';
        container.innerHTML = html;
    }
}

function renderAlerts(alerts) {
    const container = document.getElementById('alerts-panel');
    if (!alerts || alerts.length === 0) {
        container.innerHTML = '<p class="text-center text-success">No alerts. All systems normal.</p>';
    } else {
        let html = '<ul class="list-group">';
        alerts.forEach(alert => {
            html += `<li class="list-group-item list-group-item-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>${alert}
            </li>`;
        });
        html += '</ul>';
        container.innerHTML = html;
    }
}

function updateBadges(data) {
    document.getElementById('user-count-badge').textContent = data.total_users || 0;
    document.getElementById('loan-count-badge').textContent = data.total_loans || 0;
    document.getElementById('transaction-count-badge').textContent = data.total_transactions || 0;
}

// Load Users Data - CRITICAL FUNCTION
async function loadUsersData() {
    try {
        const roleFilter = document.getElementById('user-role-filter').value;
        const statusFilter = document.getElementById('user-status-filter').value;
        const searchTerm = document.getElementById('user-search').value.trim().toLowerCase();
        
        const response = await fetch('/admin/api/users');
        const result = await response.json();
        if (result.status === 'success') {
            let users = result.data;
            
            // Apply client-side filters
            if (roleFilter) users = users.filter(u => u.role === roleFilter);
            if (statusFilter) users = users.filter(u => (u.is_active ? 'active' : 'inactive') === statusFilter);
            if (searchTerm) users = users.filter(u =>
                u.username.toLowerCase().includes(searchTerm) ||
                (u.full_name || '').toLowerCase().includes(searchTerm) ||
                (u.email || '').toLowerCase().includes(searchTerm)
            );
            
            currentData.users = result.data; // Store original data
            renderUsersTable(users);
        } else {
            showError(result.message || 'Failed to load users');
            document.getElementById('users-table-container').innerHTML = '<p class="text-center text-muted">Failed to load users</p>';
        }
    } catch (error) {
        console.error('Error loading users data:', error);
        showError('Failed to load users data');
        document.getElementById('users-table-container').innerHTML = '<p class="text-center text-muted">Failed to load users</p>';
    }
}

function renderUsersTable(users) {
    const container = document.getElementById('users-table-container');
    if (!users || users.length === 0) {
        container.innerHTML = '<p class="text-center">No users found.</p>';
        return;
    }
    
    const tableHTML = `
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Username</th>
                    <th>Full Name</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Role</th>
                    <th>Status</th>
                    <th>Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                ${users.map(user => `
                    <tr>
                        <td>${user.id}</td>
                        <td><strong>${user.username}</strong></td>
                        <td>${user.full_name || 'N/A'}</td>
                        <td>${user.email || 'N/A'}</td>
                        <td>${user.phone_number || 'N/A'}</td>
                        <td><span class="badge bg-${user.role === 'admin' ? 'danger' : 'primary'}">${user.role}</span></td>
                        <td><span class="badge bg-${user.is_active ? 'success' : 'secondary'}">${user.is_active ? 'Active' : 'Inactive'}</span></td>
                        <td>${formatDate(user.created_at)}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="editUser(${user.id})" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-info" onclick="viewUserDetails(${user.id})" title="View">
                                    <i class="fas fa-eye"></i>
                                </button>
                                ${user.role !== 'admin' ? `
                                <button class="btn btn-outline-${user.is_active ? 'warning' : 'success'}" 
                                        onclick="toggleUserStatus(${user.id}, ${!user.is_active})" 
                                        title="${user.is_active ? 'Deactivate' : 'Activate'}">
                                    <i class="fas fa-${user.is_active ? 'ban' : 'check'}"></i>
                                </button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
    container.innerHTML = tableHTML;
}

// Load Loans Data - CRITICAL FUNCTION
async function loadLoansData() {
    try {
        const statusFilter = document.getElementById('loan-status-filter').value;
        const amountFilter = document.getElementById('loan-amount-filter').value;
        const searchTerm = document.getElementById('loan-search').value.trim().toLowerCase();
        
        const response = await fetch('/admin/api/loans');
        const result = await response.json();
        if (result.status === 'success') {
            const payload = result.data;
            currentData.loans = payload;
            renderLoanSummaryCards(payload.summary);
            
            // Apply client-side filtering
            let loans = payload.loans;
            if (statusFilter) loans = loans.filter(l => l.status === statusFilter);
            if (amountFilter) {
                loans = loans.filter(l => {
                    const amt = Number(l.original_amount);
                    if (amountFilter === '5000+') return amt >= 5000;
                    const [min, max] = amountFilter.split('-').map(Number);
                    return amt >= min && amt <= max;
                });
            }
            if (searchTerm) loans = loans.filter(l =>
                l.customer_name.toLowerCase().includes(searchTerm) ||
                String(l.loan_id).includes(searchTerm)
            );
            
            renderLoansTable(loans);
            loadCustomersForLoanForm(); // Populate loan form dropdown
        } else {
            showError(result.message || 'Failed to load loans');
            document.getElementById('loans-table-container').innerHTML = '<p class="text-center text-muted">Failed to load loans</p>';
        }
    } catch (error) {
        console.error('Error loading loans data:', error);
        showError('Failed to load loans data');
        document.getElementById('loans-table-container').innerHTML = '<p class="text-center text-muted">Failed to load loans</p>';
    }
}

function renderLoanSummaryCards(summary) {
    const container = document.getElementById('loan-summary-cards');
    if (!summary) {
        container.innerHTML = '<p class="text-center">No loan summary available.</p>';
        return;
    }
    
    container.innerHTML = `
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <h4>${summary.total_loans || 0}</h4>
                    <p class="mb-0">Total Loans</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <h4>${summary.active_loans || 0}</h4>
                    <p class="mb-0">Active Loans</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <h4>$${formatNumber(summary.total_disbursed || 0)}</h4>
                    <p class="mb-0">Total Disbursed</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body text-center">
                    <h4>$${formatNumber(summary.total_outstanding || 0)}</h4>
                    <p class="mb-0">Outstanding</p>
                </div>
            </div>
        </div>
    `;
}

// Dashboard Initialization and Event Binding
function initializeDashboard() {
    console.log("Initializing dashboard...");
    loadOverviewData();
}

function bindTabEvents() {
    document.querySelectorAll('#dashboardTabs .nav-link').forEach(tab => {
        tab.addEventListener('shown.bs.tab', function(event) {
            const tabName = event.target.getAttribute('data-bs-target').substring(1);
            handleTabChange(tabName);
        });
    });
}

function handleTabChange(tabName) {
    console.log(`Tab changed to: ${tabName}`);
    // Load data for the specific tab if it hasn't been loaded yet
    if (tabName === 'users' && !currentData.users) {
        loadUsersData();
    } else if (tabName === 'loans' && !currentData.loans) {
        loadLoansData();
    } else if (tabName === 'transactions' && !currentData.transactions) {
        loadTransactionsData();
    } else if (tabName === 'analytics' && !currentData.analytics) {
        loadAnalyticsData();
    } else if (tabName === 'security' && !currentData.security) {
        loadSecurityData();
    }
}

function refreshAllData() {
    showSuccess('Refreshing all data...');
    // Invalidate current data
    currentData = {};
    // Get current active tab
    const activeTabEl = document.querySelector('#dashboardTabs .nav-link.active');
    if (!activeTabEl) return;
    
    const activeTab = activeTabEl.getAttribute('data-bs-target').substring(1);
    
    // Show spinners
    document.getElementById('overview-cards').innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div></div>';
    document.getElementById('users-table-container').innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div></div>';
    document.getElementById('loans-table-container').innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div></div>';
    document.getElementById('transactions-table-container').innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div></div>';

    // Reload overview data (which updates badges) and current tab data
    loadOverviewData();
    handleTabChange(activeTab);
}

// Stub functions for unimplemented actions
function exportData() { showModal('Export Data', 'This feature is not yet implemented.'); }
function showSystemHealth() { showModal('System Health', 'This feature is not yet implemented.'); }
function showReports() { showModal('Generate Reports', 'This feature is not yet implemented.'); }
function exportUsers() { showModal('Export Users', 'This feature is not yet implemented.'); }
function clearUserFilters() { 
    document.getElementById('user-role-filter').value = '';
    document.getElementById('user-status-filter').value = '';
    document.getElementById('user-search').value = '';
    loadUsersData(); 
}
function searchUsers() { loadUsersData(); }
function filterUsers() { loadUsersData(); }
function exportLoans() { showModal('Export Loans', 'This feature is not yet implemented.'); }
function clearLoanFilters() { 
    document.getElementById('loan-status-filter').value = '';
    document.getElementById('loan-amount-filter').value = '';
    document.getElementById('loan-search').value = '';
    loadLoansData();
}
function searchLoans() { loadLoansData(); }
function filterLoans() { loadLoansData(); }
function refreshTransactions() { loadTransactionsData(); }
function exportTransactions() { showModal('Export Transactions', 'This feature is not yet implemented.'); }
function clearTransactionFilters() {
    document.getElementById('transaction-status-filter').value = '';
    document.getElementById('transaction-method-filter').value = '';
    document.getElementById('transaction-period-filter').value = '';
    document.getElementById('transaction-search').value = '';
    loadTransactionsData();
}
function searchTransactions() { loadTransactionsData(); }
function filterTransactions() { loadTransactionsData(); }


// User and Loan Actions
function showAddUser() {
    document.getElementById('addUserForm').reset();
    new bootstrap.Modal(document.getElementById('addUserModal')).show();
}

async function submitAddUser() {
    const form = document.getElementById('addUserForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    try {
        const response = await fetch('/admin/api/users', {
            method: 'POST',
            headers: getCSRFHeaders(),
            body: JSON.stringify(data)
        });
        const result = await response.json();
        if (result.status === 'success') {
            showSuccess('User added successfully!');
            bootstrap.Modal.getInstance(document.getElementById('addUserModal')).hide();
            loadUsersData();
            loadOverviewData(); // To update counts
        } else {
            showError(result.message || 'Failed to add user.');
        }
    } catch (error) {
        showError('An error occurred while adding the user.');
    }
}

function editUser(userId) {
    showModal('Edit User', `Editing user ${userId}. This feature is not yet implemented.`);
}

async function viewUserDetails(userId) {
    try {
        const response = await fetch(`/admin/api/users/${userId}`);
        const result = await response.json();
        if (result.status === 'success') {
            const user = result.data;
            const bodyHtml = `
                <p><strong>ID:</strong> ${user.id}</p>
                <p><strong>Username:</strong> ${user.username}</p>
                <p><strong>Email:</strong> ${user.email}</p>
                <p><strong>Full Name:</strong> ${user.full_name}</p>
                <p><strong>Phone:</strong> ${user.phone_number}</p>
                <p><strong>Role:</strong> ${user.role}</p>
                <p><strong>Status:</strong> ${user.is_active ? 'Active' : 'Inactive'}</p>
                <p><strong>Created At:</strong> ${formatDate(user.created_at)}</p>
            `;
            showModal(`User Details: ${user.username}`, bodyHtml);
        } else {
            showError(result.message || 'Failed to fetch user details.');
        }
    } catch (error) {
        showError('An error occurred while fetching user details.');
    }
}

async function toggleUserStatus(userId, newStatus) {
    try {
        const response = await fetch(`/admin/api/users/${userId}/toggle-status`, {
            method: 'POST',
            headers: getCSRFHeaders(),
            body: JSON.stringify({ is_active: newStatus })
        });
        const result = await response.json();
        if (result.status === 'success') {
            showSuccess(`User status updated successfully.`);
            loadUsersData();
        } else {
            showError(result.message || 'Failed to update user status.');
        }
    } catch (error) {
        showError('An error occurred while updating user status.');
    }
}

function showAddLoan() {
    document.getElementById('addLoanForm').reset();
    new bootstrap.Modal(document.getElementById('addLoanModal')).show();
}

async function submitAddLoan() {
    const form = document.getElementById('addLoanForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    try {
        const response = await fetch('/admin/api/loans', {
            method: 'POST',
            headers: getCSRFHeaders(),
            body: JSON.stringify(data)
        });
        const result = await response.json();
        if (result.status === 'success') {
            showSuccess('Loan created successfully!');
            bootstrap.Modal.getInstance(document.getElementById('addLoanModal')).hide();
            loadLoansData();
            loadOverviewData(); // To update counts
        } else {
            showError(result.message || 'Failed to create loan.');
        }
    } catch (error) {
        showError('An error occurred while creating the loan.');
    }
}

async function loadCustomersForLoanForm() {
    // Ensure users are loaded, but don't force a re-render of the user table
    if (!currentData.users || currentData.users.length === 0) {
         try {
            const response = await fetch('/admin/api/users');
            const result = await response.json();
            if (result.status === 'success') {
                currentData.users = result.data;
            } else {
                 showError('Could not load customers for loan form.');
                 return;
            }
        } catch(e) {
             showError('Could not load customers for loan form.');
             return;
        }
    }
    
    const select = document.querySelector('#addLoanForm select[name="user_id"]');
    if (!select) return;
    
    select.innerHTML = '<option value="">Select Customer...</option>';
    currentData.users
        .filter(u => u.role === 'customer' && u.is_active)
        .forEach(user => {
            const option = document.createElement('option');
            option.value = user.id;
            option.textContent = `${user.full_name || user.username} (ID: ${user.id})`;
            select.appendChild(option);
        });
}

function editLoan(loanId) {
    showModal('Edit Loan', `Editing loan ${loanId}. This feature is not yet implemented.`);
}

async function viewLoanDetails(loanId) {
    try {
        const response = await fetch(`/admin/api/loans/${loanId}`);
        const result = await response.json();
        if (result.status === 'success') {
            const loan = result.data;
            const bodyHtml = `
                <h4>Loan Details (ID: ${loan.loan_id})</h4>
                <p><strong>Customer:</strong> ${loan.customer_name}</p>
                <p><strong>Original Amount:</strong> $${formatNumber(loan.original_amount)}</p>
                <p><strong>Outstanding Balance:</strong> $${formatNumber(loan.outstanding_balance)}</p>
                <p><strong>Interest Rate:</strong> ${loan.interest_rate}%</p>
                <p><strong>Status:</strong> ${loan.status}</p>
                <p><strong>Disbursement Date:</strong> ${formatDate(loan.disbursement_date)}</p>
                <hr/>
                <h5>Repayments</h5>
                <p>This section is not yet implemented.</p>
            `;
            showModal(`Loan Details: ${loan.loan_id}`, bodyHtml);
        } else {
            showError(result.message || 'Failed to fetch loan details.');
        }
    } catch (error) {
        showError('An error occurred while fetching loan details.');
    }
}

// Transaction Actions
async function viewTransactionDetails(transactionId) {
     try {
        const response = await fetch(`/admin/api/transactions/${transactionId}`);
        const result = await response.json();
        if (result.status === 'success') {
            const t = result.data;
            const bodyHtml = `
                <p><strong>Transaction ID:</strong> ${t.transaction_id}</p>
                <p><strong>Loan ID:</strong> ${t.loan_id}</p>
                <p><strong>Amount:</strong> $${formatNumber(t.amount)}</p>
                <p><strong>Fee:</strong> $${formatNumber(t.fee)}</p>
                <p><strong>Total:</strong> $${formatNumber(t.total)}</p>
                <p><strong>Method:</strong> ${t.method}</p>
                <p><strong>Status:</strong> ${t.status}</p>
                <p><strong>Poll URL:</strong> ${t.poll_url || 'N/A'}</p>
                <p><strong>Paynow Reference:</strong> ${t.paynow_reference || 'N/A'}</p>
                <p><strong>Created At:</strong> ${formatDate(t.created_at)}</p>
            `;
            showModal(`Transaction Details: ${t.transaction_id}`, bodyHtml);
        } else {
            showError(result.message || 'Failed to fetch transaction details.');
        }
    } catch (error) {
        showError('An error occurred while fetching transaction details.');
    }
}

// Transaction filtering with front-end logic
async function loadTransactionsData() {
    try {
        // Read filters
        const statusFilter = document.getElementById('transaction-status-filter').value;
        const methodFilter = document.getElementById('transaction-method-filter').value;
        const periodFilter = document.getElementById('transaction-period-filter').value;
        const searchTerm = document.getElementById('transaction-search').value.trim().toLowerCase();
        
        const response = await fetch('/admin/api/transactions');
        const result = await response.json();
        if (result.status === 'success') {
            const payload = result.data;
            currentData.transactions = payload;
            renderTransactionSummaryCards(payload.summary);
            
            // Apply front-end filtering
            let transactions = payload.transactions;
            if (statusFilter) transactions = transactions.filter(t => t.status === statusFilter);
            if (methodFilter) transactions = transactions.filter(t => t.method === methodFilter);
            if (searchTerm) transactions = transactions.filter(t =>
                String(t.transaction_id).includes(searchTerm) ||
                String(t.loan_id).includes(searchTerm) ||
                t.reference?.toLowerCase().includes(searchTerm)
            );
            
            // Period filtering (basic implementation)
            if (periodFilter) {
                const now = new Date();
                const filtered = transactions.filter(t => {
                    const txDate = new Date(t.created_at);
                    switch(periodFilter) {
                        case 'today': return txDate.toDateString() === now.toDateString();
                        case 'week': return (now - txDate) <= 7 * 24 * 60 * 60 * 1000;
                        case 'month': return txDate.getMonth() === now.getMonth() && txDate.getFullYear() === now.getFullYear();
                        default: return true;
                    }
                });
                transactions = filtered;
            }
            
            renderTransactionsTable(transactions);
        } else {
            showError(result.message || 'Failed to load transactions');
        }
    } catch (error) {
        console.error('Error loading transactions data:', error);
        showError('Failed to load transactions data');
    }
}

function filterTransactions() { loadTransactionsData(); }
function searchTransactions() { loadTransactionsData(); }
function clearTransactionFilters() { 
    document.getElementById('transaction-status-filter').value = '';
    document.getElementById('transaction-method-filter').value = '';
    document.getElementById('transaction-period-filter').value = '';
    document.getElementById('transaction-search').value = '';
    loadTransactionsData();
}
function refreshTransactions() { loadTransactionsData(); }

// Export/Report stubs - replace alerts with actual implementation
function showSystemHealth() { 
    showModal('System Health', '<p>All systems operational. Database connected. API responsive.</p>');
}
function exportData() { alert('Export feature coming soon'); }
function exportUsers() { alert('User export feature coming soon'); }
function exportLoans() { alert('Loan export feature coming soon'); }
function exportTransactions() { alert('Transaction export feature coming soon'); }
function showReports() { alert('Advanced reporting feature coming soon'); }

// Security loader
async function loadSecurityData() {
    const logContainer = document.getElementById('login-attempts-table');
    const healthContainer = document.getElementById('system-health');
    logContainer.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div></div>';
    healthContainer.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div></div>';
    try {
        const res = await fetch('/admin/api/overview');
        const result = await res.json();
        if (result.status === 'success') {
            const logins = result.data.recent_activity.logins || [];
            if (logins.length) {
                let html = '<ul class="list-group">';
                logins.forEach(l => { html += `<li class="list-group-item">${l.username || l.user_id} at ${formatDate(l.created_at)}</li>`; });
                html += '</ul>';
                logContainer.innerHTML = html;
            } else logContainer.innerHTML = '<p class="text-center">No login attempts.</p>';
            healthContainer.innerHTML = `<p class="text-center">Last updated: ${new Date(result.data.last_updated).toLocaleString()}</p>`;
        } else {
            logContainer.innerHTML = '<p class="text-center">No login attempts.</p>';
            healthContainer.innerHTML = '<p class="text-center">System health unknown.</p>';
        }
    } catch (e) {
        console.error(e);
        logContainer.innerHTML = '<p class="text-center">Failed to load login attempts.</p>';
        healthContainer.innerHTML = '<p class="text-center">Failed to load system health.</p>';
    }
}

function bindSidebarEvents() {
    // Handle sidebar navigation
    document.querySelectorAll('.sidebar .nav-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const tabName = this.getAttribute('data-tab');
            if (tabName) {
                // Update active states
                document.querySelectorAll('.sidebar .nav-link').forEach(l => l.classList.remove('active'));
                this.classList.add('active');
                
                // Show corresponding tab
                document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('show', 'active'));
                const targetPane = document.getElementById(tabName);
                if (targetPane) {
                    targetPane.classList.add('show', 'active');
                    handleTabChange(tabName);
                }
                
                // Update nav tabs
                document.querySelectorAll('#dashboardTabs .nav-link').forEach(tab => tab.classList.remove('active'));
                const navTab = document.getElementById(`${tabName}-tab`);
                if (navTab) navTab.classList.add('active');
            }
        });
    });
}

// Improved payment form implementation
function showPaymentForm(loanId) {
    const modalHtml = `
        <form id="paymentForm">
            <div class="mb-3">
                <label class="form-label">Loan ID</label>
                <input type="text" class="form-control" value="${loanId}" readonly>
            </div>
            <div class="mb-3">
                <label class="form-label">Payment Amount ($)</label>
                <input type="number" class="form-control" name="amount" step="0.01" required>
            </div>
            <div class="mb-3">
                <label class="form-label">Payment Method</label>
                <select class="form-select" name="method" required>
                    <option value="">Select Method...</option>
                    <option value="ecocash">EcoCash</option>
                    <option value="onemoney">OneMoney</option>
                    <option value="omari">Omari</option>
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label">Phone Number</label>
                <input type="tel" class="form-control" name="phone" placeholder="07xxxxxxxx" required>
            </div>
            <input type="hidden" name="loan_id" value="${loanId}">
        </form>
        <div class="mt-3">
            <button class="btn btn-success" onclick="submitPayment()">Process Payment</button>
            <button class="btn btn-secondary ms-2" data-bs-dismiss="modal">Cancel</button>
        </div>
    `;
    showModal(`üí∞ Make Payment for Loan ${loanId}`, modalHtml);
}

async function submitPayment() {
    const form = document.getElementById('paymentForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    try {
        const response = await fetch('/admin/api/payments', {
            method: 'POST',
            headers: getCSRFHeaders(),
            body: JSON.stringify(data)
        });
        const result = await response.json();
        if (result.status === 'success') {
            // Check if this is an OMari payment that requires OTP
            if (data.method === 'omari' && result.data && result.data.remoteotpurl) {
                // Hide payment modal and show OTP modal
                bootstrap.Modal.getInstance(document.getElementById('genericModal')).hide();
                showOmariOtpModal(result.data);
            } else {
                showSuccess('Payment initiated successfully!');
                bootstrap.Modal.getInstance(document.getElementById('genericModal')).hide();
                loadTransactionsData(); // Refresh transactions
                loadLoansData(); // Refresh loans
            }
        } else {
            showError(result.message || 'Failed to process payment.');
        }
    } catch (error) {
        showError('An error occurred while processing the payment.');
    }
}

// OMari OTP Modal Implementation
function showOmariOtpModal(paymentData) {
    const modalHtml = `
        <div class="alert alert-info">
            <i class="fas fa-mobile-alt"></i> 
            <strong>OMari Payment Initiated</strong><br>
            An OTP has been sent to your phone. Please enter it below to complete the payment.
        </div>
        <form id="otpForm">
            <input type="hidden" name="reference" value="${paymentData.reference}">
            <div class="mb-3">
                <label class="form-label">Payment Reference</label>
                <input type="text" class="form-control" value="${paymentData.reference}" readonly>
            </div>
            <div class="mb-3">
                <label class="form-label">Enter OTP <span class="text-danger">*</span></label>
                <input type="text" 
                       class="form-control" 
                       name="otp" 
                       placeholder="Enter 6-digit OTP" 
                       maxlength="6" 
                       pattern="[0-9]{6}"
                       required>
                <small class="form-text text-muted">Check your phone for the 6-digit verification code</small>
            </div>
            <div class="d-flex gap-2">
                <button type="button" class="btn btn-secondary" onclick="requestNewOtp('${paymentData.reference}')">
                    <i class="fas fa-redo"></i> Resend OTP
                </button>
                <button type="button" class="btn btn-success" onclick="submitOtp()">
                    <i class="fas fa-check"></i> Verify & Complete Payment
                </button>
            </div>
        </form>
    `;
    
    showModal('üîê Enter OMari OTP', modalHtml);
}

async function submitOtp() {
    const form = document.getElementById('otpForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    // Validate OTP format
    if (!data.otp || data.otp.length !== 6 || !/^\d{6}$/.test(data.otp)) {
        showError('Please enter a valid 6-digit OTP');
        return;
    }
    
    try {
        const response = await fetch('api/payment/otp', {
            method: 'POST',
            headers: getCSRFHeaders(),
            body: JSON.stringify({
                reference: data.reference,
                otp: data.otp
            })
        });
        
        const result = await response.json();
        if (result.status === 'success') {
            showSuccess('Payment completed successfully!');
            bootstrap.Modal.getInstance(document.getElementById('genericModal')).hide();
            loadTransactionsData(); // Refresh transactions
            loadLoansData(); // Refresh loans
        } else {
            showError(result.message || 'Invalid OTP. Please try again.');
        }
    } catch (error) {
        showError('An error occurred while verifying OTP.');
    }
}

async function requestNewOtp(reference) {
    try {
        const response = await fetch('/api/payment/otp/request', {
            method: 'POST',
            headers: getCSRFHeaders(),
            body: JSON.stringify({ reference: reference })
        });
        
        const result = await response.json();
        if (result.status === 'success') {
            showSuccess('A new OTP has been sent to your phone');
        } else {
            showError(result.message || 'Failed to resend OTP');
        }
    } catch (error) {
        showError('An error occurred while requesting new OTP');
    }
}

// CSRF Testing and Debugging Functions
async function testCSRF() {
    console.log('Testing CSRF token...');
    console.log('Current CSRF_TOKEN:', CSRF_TOKEN);
    
    try {
        const response = await fetch('/admin/api/test-csrf', {
            method: 'POST',
            headers: getCSRFHeaders(),
            body: JSON.stringify({ test: 'data', timestamp: new Date().toISOString() })
        });
        
        const result = await response.json();
        if (response.ok && result.status === 'success') {
            showSuccess('CSRF token test passed! ‚úÖ');
            console.log('CSRF test result:', result);
        } else {
            showError(`CSRF test failed: ${result.message || 'Unknown error'}`);
            console.error('CSRF test failed:', result);
        }
    } catch (error) {
        showError(`CSRF test error: ${error.message}`);
        console.error('CSRF test error:', error);
    }
}

function debugCSRF() {
    const debugInfo = {
        'CSRF_TOKEN': CSRF_TOKEN,
        'window.csrf_token': window.csrf_token,
        'Meta tag content': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content'),
        'Headers function': getCSRFHeaders(),
        'Token length': CSRF_TOKEN ? CSRF_TOKEN.length : 0,
        'Token valid': !!CSRF_TOKEN && CSRF_TOKEN.length > 10
    };
    
    console.log('CSRF Debug Info:', debugInfo);
    
    const debugHtml = `
        <div class="table-responsive">
            <table class="table table-bordered">
                ${Object.entries(debugInfo).map(([key, value]) => `
                    <tr>
                        <td><strong>${key}</strong></td>
                        <td><code>${JSON.stringify(value)}</code></td>
                    </tr>
                `).join('')}
            </table>
        </div>
        <div class="mt-3">
            <button class="btn btn-primary" onclick="testCSRF()">Run CSRF Test</button>
        </div>
    `;
    
    showModal('üêõ CSRF Debug Information', debugHtml);
}

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    console.log('Enhanced dashboard initialized');
    console.log('CSRF Token loaded:', !!CSRF_TOKEN);
    initializeDashboard();
    bindTabEvents();
    bindSidebarEvents();
});
</script>
{% endblock %}
